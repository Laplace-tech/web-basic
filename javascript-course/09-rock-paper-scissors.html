<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>dom-rock-scissors-paper</title>
</head>

<body>
  <p>Rock Paper Scissors</p>

  <button onclick="playGame('rock')">rock</button>
  <button onclick="playGame('scissors')">scissors</button>
  <button onclick="playGame('paper')">paper</button>

  <p class="js-result"></p>
  <p class="js-moves"></p>
  <p class="js-record"></p>

  <button onclick="resetRecord()">Reset Record</button>

  <script>
    const record = {
      wins: 0,
      losses: 0,
      ties: 0,
    };

    // 초기화
    loadPreviousRecord();
    showRecordElement();

    function playGame(playerMove) {
      const computerMove = getComputerMove();
      const result = fightEachOther(playerMove, computerMove);

      updateRecord(result);
      saveRecord();

      showResultElement(result);
      showMovesElement(playerMove, computerMove);
    }

    function getComputerMove() {
      const random = Math.random();
      if (random < 1 / 3) return "rock";
      else if (random < 2 / 3) return "scissors";
      else return "paper";
    }

    function fightEachOther(playerMove, computerMove) {
      if (playerMove === computerMove) return "ties";
      else if (
        (playerMove === "rock" && computerMove === "scissors") ||
        (playerMove === "scissors" && computerMove === "paper") ||
        (playerMove === "paper" && computerMove === "rock")
      ) {
        return "wins";
      } else {
        return "losses";
      }
    }

    function updateRecord(result) {
      record[result]++;
      console.log(`updateRecord(): ${JSON.stringify(record)}`);
    }

    function saveRecord() {
      const jsonRecord = JSON.stringify(record);
      console.log(`saveRecord(): jsonRecord = ${jsonRecord}`);
      localStorage.setItem("record", jsonRecord);
      showRecordElement();
    }

    function loadPreviousRecord() {
      const storedRecord = localStorage.getItem("record");
      if (!storedRecord) return;

      try {
        const parsedRecord = JSON.parse(storedRecord);
        for (const key in record) {
          if (parsedRecord.hasOwnProperty(key)) {
            record[key] = Number(parsedRecord[key]) || 0;
          }
        }
      } catch (error) {
        console.warn("loadPreviousRecord(): JSON parse failed", error);
        localStorage.removeItem("record"); // 손상된 데이터 초기화
      }
    }

    function showResultElement(gameResult) {
      document.querySelector(".js-result").textContent = `You ${gameResult}!`;
    }

    function showMovesElement(playerMove, computerMove) {
      document.querySelector(".js-moves").textContent = 
        `Player: ${playerMove}, Computer: ${computerMove}`;
    }

    function showRecordElement() {
      document.querySelector(".js-record").textContent =
        `Wins: ${record.wins}, Losses: ${record.losses}, Ties: ${record.ties}`;
    }

    function resetRecord() {
      record.wins = 0;
      record.losses = 0;
      record.ties = 0;
      saveRecord();
    }
  </script>
</body>
</html>
